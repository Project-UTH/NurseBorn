<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <th:block th:replace="~{master/head :: head}"></th:block>
    <title>Đánh Giá Dịch Vụ - NurseBorn</title>
    <style>
        .feedback-form {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background-color: #007bff;
            color: #fff;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
        }
        .rating {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .rating input {
            display: none;
        }
        .rating label {
            font-size: 30px;
            color: #ddd;
            cursor: pointer;
            transition: color 0.3s ease;
            margin: 0 2px;
        }
        .rating input:checked ~ label,
        .rating input:hover ~ label,
        .rating label:hover,
        .rating label:hover ~ label {
            color: #ffc107;
        }
        .btn-submit {
            background-color: #007bff;
            border-color: #007bff;
            border-radius: 25px;
            padding: 8px 20px;
            font-weight: 500;
            transition: background-color 0.3s ease;
            color: #fff;
            width: 100%;
        }
        .btn-submit:hover {
            background-color: #0056b3;
            border-color: #004085;
        }
        select, textarea {
            width: 100%;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
            padding: 10px;
        }
        .form-label {
            font-weight: 500;
            margin-bottom: 5px;
        }
        .booking-info {
            margin-bottom: 20px;
        }
        .status-completed {
            color: #17a2b8;
            font-weight: 500;
        }
        .card-text {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
<div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">
        <div th:replace="~{family/layoutmenufamily :: menu}"></div>
        <div class="layout-page">
            <div th:replace="~{master/navbar :: navbar}"></div>
            <div class="content-wrapper">
                <div class="content-xxl flex-grow-1 container-p-y">
                    <div class="card mb-4">
                        <h5 class="card-header text-center">Đánh Giá Dịch Vụ</h5>
                        <div class="card-body">
                            <!-- Error Message -->
                            <div th:if="${error}" class="alert alert-danger alert-dismissible" role="alert">
                                <span th:text="${error}"></span>
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                            <!-- Success Message -->
                            <div th:if="${success}" class="alert alert-success alert-dismissible" role="alert">
                                <span th:text="${success}"></span>
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                            <!-- Booking Info -->
                            <div class="booking-info" th:if="${booking != null}">
                                <h5 class="card-title">
                                    <span th:text="'Bệnh Dưỡng: ' + ${booking.nurseUser.fullName}"></span>
                                </h5>
                                <p class="card-text">
                                    <strong>Mã đặt lịch:</strong>
                                    <span th:text="${booking.bookingId}"></span>
                                </p>
                                <p class="card-text">
                                    <strong>Ngày đặt:</strong>
                                    <span th:text="${booking.bookingDate}"></span>
                                </p>
                                <p class="card-text">
                                    <strong>Loại dịch vụ:</strong>
                                    <span th:text="${booking.serviceType}"></span>
                                </p>
                                <p class="card-text" th:if="${booking.serviceType == 'HOURLY'}">
                                    <strong>Giờ bắt đầu:</strong>
                                    <span th:text="${booking.startTime}"></span>
                                    <br>
                                    <strong>Giờ kết thúc:</strong>
                                    <span th:text="${booking.endTime}"></span>
                                </p>
                                <p class="card-text">
                                    <strong>Giá:</strong>
                                    <span th:text="${booking.price} + ' VND'"></span>
                                </p>
                                <p class="card-text">
                                    <strong>Trạng thái:</strong>
                                    <span th:class="'status-' + ${#strings.toLowerCase(booking.status.name())}"
                                          th:text="${booking.status}"></span>
                                </p>
                                <p class="card-text">
                                    <strong>Ghi chú:</strong>
                                    <span th:text="${booking.notes != null ? booking.notes : 'Không có ghi chú'}"></span>
                                </p>
                            </div>
                            <!-- Feedback Form -->
                            <div class="feedback-form">
                                <form th:action="@{/family/submit-feedback}" method="post" enctype="multipart/form-data">
                                    <input type="hidden" name="bookingId" th:value="${booking?.bookingId}"/>
                                    <input type="hidden" name="nurseId" th:value="${booking?.nurseUser?.userId}"/>
                                    <div class="mb-3">
                                        <label for="star5" class="form-label">Đánh giá của bạn:</label>
                                        <div class="rating">
                                            <input type="radio" id="star5" name="rating" value="5" required/>
                                            <label for="star5">★</label>
                                            <input type="radio" id="star4" name="rating" value="4"/>
                                            <label for="star4">★</label>
                                            <input type="radio" id="star3" name="rating" value="3"/>
                                            <label for="star3">★</label>
                                            <input type="radio" id="star2" name="rating" value="2"/>
                                            <label for="star2">★</label>
                                            <input type="radio" id="star1" name="rating" value="1"/>
                                            <label for="star1">★</label>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="comment" class="form-label">Chia sẻ đánh giá của bạn:</label>
                                        <textarea id="comment" name="comment" placeholder="Chia sẻ đánh giá của bạn..." required></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="attachment" class="form-label">Tải lên hình ảnh hoặc tệp PDF (tối đa 5 tệp):</label>
                                        <input type="file" id="attachment" name="attachment" accept="image/*,.pdf" multiple/>
                                    </div>
                                    <button type="submit" class="btn btn-submit">Gửi đánh giá</button>
                                </form>
                                <div class="text-center mt-3">
                                    <a href="/family/bookings" class="text-muted">Quay lại danh sách lịch đặt</a>
                                </div>
                            </div>
                            <!-- Nurse Review Section -->
                            <div id="nurse_review" class="mt-4">
                                <h5>Đánh giá của y tá</h5>
                                <div id="reviews_list" th:if="${booking != null}">
                                    <div th:each="feedback : ${feedbacks}" th:if="${feedback.booking.nurseUser.userId == booking.nurseUser.userId}">
                                        <p>Đánh giá: <span th:text="${feedback.rating} + ' sao'"></span> - <span th:text="${feedback.comment}"></span></p>
                                    </div>
                                    <div th:if="${feedbacks == null or #lists.isEmpty(feedbacks)}">
                                        <p>Chưa có đánh giá nào cho y tá này.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Core JS -->
<script src="/static/assets/vendor/libs/jquery/jquery.js"></script>
<script src="/static/assets/vendor/libs/popper/popper.js"></script>
<script src="/static/assets/vendor/js/bootstrap.js"></script>
<script src="/static/assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
<script src="/static/assets/vendor/js/menu.js"></script>
<script src="/static/assets/vendor/libs/apex-charts/apexcharts.js"></script>
<script src="/static/assets/js/main.js"></script>
<script src="/static/assets/js/dashboards-analytics.js"></script>
<script async defer src="https://buttons.github.io/buttons.js"></script>
<script>
    // Validate file upload
    document.getElementById('attachment').addEventListener('change', function(e) {
        const files = e.target.files;
        const maxFiles = 5;
        const maxFileSize = 5 * 1024 * 1024; // 5MB

        if (files.length > maxFiles) {
            alert(`Bạn chỉ có thể tải lên tối đa ${maxFiles} tệp`);
            e.target.value = '';
            return;
        }

        for (let file of files) {
            if (file.size > maxFileSize) {
                alert('Kích thước tệp không được vượt quá 5MB');
                e.target.value = '';
                return;
            }
        }
    });
</script>
</body>
</html>